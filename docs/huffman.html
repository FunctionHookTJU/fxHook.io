<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœå¤«æ›¼ç¼–ç å¯è§†åŒ– - å®‡ä½è§å‡½é’©</title>
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/icons/favicon-16x16.png">
    <link rel="manifest" href="../site.webmanifest">
    <script src="../scripts/header.js" defer></script>
    <style>
        :root {
            --primary-color: #8527d2b2;
            --secondary-color: #f5f5f5eb;
            --text-color: #333;
            --light-text: #fff;
            --transition: all 0.3s ease;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --node-leaf: #4CAF50;
            --node-internal: #FF9800;
            --node-root: #E91E63;
            --edge-color: #666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--secondary-color);
            background-image: url('https://cdn.jsdelivr.net/gh/FunctionHookTJU/fxHook.io@master/assets/images/background4k.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(245, 245, 245, 0.29);
            z-index: -1;
        }

        .main-container {
            max-width: 1600px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .page-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content-wrapper {
            display: flex;
            gap: 20px;
            padding: 30px;
            flex-wrap: wrap;
        }

        .left-panel {
            flex: 1;
            min-width: 350px;
        }

        .right-panel {
            flex: 2;
            min-width: 600px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .section h3 {
            color: #555;
            margin: 15px 0 10px;
            font-size: 1.1em;
        }

        .section p {
            margin-bottom: 12px;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-step {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        }

        /* ç¤ºä¾‹æŒ‰é’® */
        .examples {
            margin-top: 15px;
        }

        .examples span {
            font-weight: 600;
            margin-right: 10px;
        }

        .example-btn {
            padding: 6px 12px;
            margin: 3px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .example-btn:hover {
            background: #667eea;
            color: white;
        }

        /* Canvas å®¹å™¨ */
        .canvas-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            min-height: 500px;
            overflow: auto;
            position: relative;
        }

        #huffmanCanvas {
            display: block;
            margin: 0 auto;
        }

        /* é¢‘ç‡è¡¨æ ¼ */
        .freq-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .freq-table th, .freq-table td {
            padding: 10px 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .freq-table th {
            background: #667eea;
            color: white;
        }

        .freq-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        /* ç¼–ç ç»“æœè¡¨æ ¼ */
        .code-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .code-table th, .code-table td {
            padding: 10px 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .code-table th {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .code-table tr:nth-child(even) {
            background: #f0fff4;
        }

        .code-table .code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #e91e63;
        }

        /* æ­¥éª¤æ˜¾ç¤º */
        .step-info {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .step-info h3 {
            color: #d84315;
            margin-bottom: 10px;
        }

        .step-counter {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        /* æ„å»ºè¿‡ç¨‹ */
        .build-process {
            background: #fff3e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .build-process h4 {
            color: #e65100;
            margin-bottom: 10px;
        }

        .build-step {
            padding: 8px 10px;
            margin: 5px 0;
            background: white;
            border-left: 3px solid #ff9800;
            border-radius: 0 5px 5px 0;
            font-size: 14px;
        }

        .build-step.active {
            background: #fff3e0;
            border-left-color: #e91e63;
        }

        /* å›¾ä¾‹ */
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .legend-color.leaf {
            background: var(--node-leaf);
        }

        .legend-color.internal {
            background: var(--node-internal);
        }

        .legend-color.root {
            background: var(--node-root);
        }

        /* ç¼–ç ç»“æœ */
        .encoded-result {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .encoded-result h4 {
            color: #00695c;
            margin-bottom: 10px;
        }

        .encoded-string {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .stat-item {
            background: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
        }

        .stat-item strong {
            color: #667eea;
        }

        /* é”™è¯¯æç¤º */
        .error-msg {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .error-msg.show {
            display: block;
        }

        /* ä»£ç å— */
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre;
            line-height: 1.5;
        }

        .code-keyword { color: #66d9ef; }
        .code-type { color: #a6e22e; }
        .code-comment { color: #75715e; }

        /* å“åº”å¼ */
        @media (max-width: 1000px) {
            .content-wrapper {
                flex-direction: column;
            }

            .left-panel, .right-panel {
                min-width: 100%;
            }

            .page-header h1 {
                font-size: 1.8em;
            }
        }

        /* Footer */
        footer {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 1rem 0;
            margin-top: auto;
        }

        footer .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        footer .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        footer .footer-links {
            display: flex;
            gap: 2rem;
        }

        footer .footer-links a {
            color: var(--light-text);
            text-decoration: none;
        }

        footer .copyright {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        /* ç®—æ³•è¯´æ˜å¡ç‰‡ */
        .algo-card {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .algo-card h4 {
            color: #4a148c;
            margin-bottom: 8px;
        }

        .algo-card ol {
            padding-left: 20px;
        }

        .algo-card li {
            margin: 5px 0;
        }

        /* èŠ‚ç‚¹åŠ¨ç”» */
        @keyframes nodeAppear {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .node-animated {
            animation: nodeAppear 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <header class="page-header">
            <h1>ğŸŒ³ éœå¤«æ›¼ç¼–ç å¯è§†åŒ–</h1>
            <p class="subtitle">Huffman Coding Visualization - ç†è§£æ•°æ®å‹ç¼©çš„æ ¸å¿ƒç®—æ³•</p>
        </header>

        <div class="content-wrapper">
            <!-- å·¦ä¾§é¢æ¿ - ç†è®ºè®²è§£ -->
            <div class="left-panel">
                <div class="section">
                    <h2>ğŸ“š ä»€ä¹ˆæ˜¯éœå¤«æ›¼ç¼–ç ï¼Ÿ</h2>
                    <p><strong>éœå¤«æ›¼ç¼–ç </strong>æ˜¯ä¸€ç§ç”¨äºæ— æŸæ•°æ®å‹ç¼©çš„æœ€ä¼˜å‰ç¼€ç¼–ç ç®—æ³•ï¼Œç”± David A. Huffman äº1952å¹´å‘æ˜ã€‚</p>
                    <p>æ ¸å¿ƒæ€æƒ³ï¼š<strong>å‡ºç°é¢‘ç‡é«˜çš„å­—ç¬¦ç”¨çŸ­ç¼–ç ï¼Œé¢‘ç‡ä½çš„ç”¨é•¿ç¼–ç </strong>ï¼Œä»è€Œä½¿æ€»ç¼–ç é•¿åº¦æœ€çŸ­ã€‚</p>
                </div>

                <div class="section">
                    <h2>ğŸ”§ æ„å»ºæ­¥éª¤</h2>
                    <div class="algo-card">
                        <h4>éœå¤«æ›¼æ ‘æ„å»ºç®—æ³•</h4>
                        <ol>
                            <li><strong>ç»Ÿè®¡é¢‘ç‡</strong>ï¼šè®¡ç®—æ¯ä¸ªå­—ç¬¦å‡ºç°çš„æ¬¡æ•°</li>
                            <li><strong>åˆ›å»ºå¶èŠ‚ç‚¹</strong>ï¼šæ¯ä¸ªå­—ç¬¦åˆ›å»ºä¸€ä¸ªå¸¦æƒå€¼çš„å¶èŠ‚ç‚¹</li>
                            <li><strong>åˆå¹¶æœ€å°</strong>ï¼šæ¯æ¬¡å–å‡ºä¸¤ä¸ªæƒå€¼æœ€å°çš„èŠ‚ç‚¹</li>
                            <li><strong>ç”Ÿæˆæ–°èŠ‚ç‚¹</strong>ï¼šåˆå¹¶ååˆ›å»ºæ–°çš„çˆ¶èŠ‚ç‚¹ï¼Œæƒå€¼ä¸ºä¸¤å­èŠ‚ç‚¹ä¹‹å’Œ</li>
                            <li><strong>é‡å¤æ­¥éª¤3-4</strong>ï¼šç›´åˆ°åªå‰©ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæ ¹èŠ‚ç‚¹ï¼‰</li>
                        </ol>
                    </div>
                </div>

                <div class="section">
                    <h2>ğŸ·ï¸ ç¼–ç è§„åˆ™</h2>
                    <p>ä»<strong>æ ¹èŠ‚ç‚¹</strong>åˆ°<strong>å¶èŠ‚ç‚¹</strong>çš„è·¯å¾„å†³å®šç¼–ç ï¼š</p>
                    <ul style="padding-left: 20px; margin-top: 10px;">
                        <li>èµ°<strong>å·¦åˆ†æ”¯</strong> â†’ è®°ä¸º <code style="color: #e91e63; font-weight: bold;">0</code></li>
                        <li>èµ°<strong>å³åˆ†æ”¯</strong> â†’ è®°ä¸º <code style="color: #2196f3; font-weight: bold;">1</code></li>
                    </ul>
                    <p style="margin-top: 10px;">æ¯ä¸ªå¶èŠ‚ç‚¹çš„è·¯å¾„ç¼–ç å°±æ˜¯è¯¥å­—ç¬¦çš„éœå¤«æ›¼ç¼–ç ã€‚</p>
                </div>

                <div class="section">
                    <h2>ğŸ’¡ ç‰¹æ€§</h2>
                    <table class="freq-table">
                        <tr>
                            <th>ç‰¹æ€§</th>
                            <th>è¯´æ˜</th>
                        </tr>
                        <tr>
                            <td><strong>å‰ç¼€ç </strong></td>
                            <td>ä»»ä½•å­—ç¬¦çš„ç¼–ç éƒ½ä¸æ˜¯å…¶ä»–å­—ç¬¦ç¼–ç çš„å‰ç¼€</td>
                        </tr>
                        <tr>
                            <td><strong>æœ€ä¼˜æ€§</strong></td>
                            <td>åœ¨æ‰€æœ‰å‰ç¼€ç ä¸­ï¼Œéœå¤«æ›¼ç¼–ç çš„å¹³å‡ç é•¿æœ€çŸ­</td>
                        </tr>
                        <tr>
                            <td><strong>æ— æŸå‹ç¼©</strong></td>
                            <td>å¯ä»¥å®Œå…¨è¿˜åŸåŸå§‹æ•°æ®</td>
                        </tr>
                    </table>
                </div>

                <div class="section">
                    <h2>ğŸ’» Cè¯­è¨€ç»“æ„</h2>
                    <div class="code-block">
<span class="code-keyword">typedef struct</span> HuffmanNode {
    <span class="code-type">char</span> ch;           <span class="code-comment">// å­—ç¬¦</span>
    <span class="code-type">int</span> freq;          <span class="code-comment">// é¢‘ç‡/æƒå€¼</span>
    <span class="code-keyword">struct</span> HuffmanNode *left;  <span class="code-comment">// å·¦å­æ ‘</span>
    <span class="code-keyword">struct</span> HuffmanNode *right; <span class="code-comment">// å³å­æ ‘</span>
} HuffmanNode;
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é¢æ¿ - äº¤äº’åŒº -->
            <div class="right-panel">
                <div class="section">
                    <h2>âœï¸ è¾“å…¥å­—ç¬¦ä¸²</h2>
                    <div class="input-group">
                        <label>è¯·è¾“å…¥åªåŒ…å«å­—æ¯çš„å­—ç¬¦ä¸²ï¼š</label>
                        <input type="text" id="inputString" placeholder="ä¾‹å¦‚: ABRACADABRA" maxlength="50">
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="buildHuffman()">ğŸš€ ä¸€é”®ç”Ÿæˆ</button>
                        <button class="btn btn-step" onclick="buildStep()">ğŸ‘£ å•æ­¥æ„å»º</button>
                        <button class="btn btn-secondary" onclick="resetAll()">ğŸ—‘ï¸ æ¸…ç©ºé‡ç½®</button>
                    </div>

                    <div class="examples">
                        <span>ç¤ºä¾‹ï¼š</span>
                        <button class="example-btn" onclick="setExample('ABRACADABRA')">ABRACADABRA</button>
                        <button class="example-btn" onclick="setExample('HELLO')">HELLO</button>
                        <button class="example-btn" onclick="setExample('MISSISSIPPI')">MISSISSIPPI</button>
                        <button class="example-btn" onclick="setExample('HUFFMAN')">HUFFMAN</button>
                        <button class="example-btn" onclick="setExample('AAAAABBBCD')">AAAAABBBCD</button>
                    </div>

                    <div id="errorMsg" class="error-msg"></div>
                </div>

                <!-- é¢‘ç‡ç»Ÿè®¡ -->
                <div class="section" id="freqSection" style="display: none;">
                    <h2>ğŸ“Š å­—ç¬¦é¢‘ç‡ç»Ÿè®¡</h2>
                    <div id="freqTable"></div>
                </div>

                <!-- æ„å»ºè¿‡ç¨‹ -->
                <div class="section" id="processSection" style="display: none;">
                    <div class="step-info">
                        <h3>ğŸ“ å½“å‰æ­¥éª¤: <span class="step-counter" id="stepCounter">0</span> / <span id="totalSteps">0</span></h3>
                        <p id="stepDescription">å‡†å¤‡å¼€å§‹æ„å»ºéœå¤«æ›¼æ ‘...</p>
                    </div>
                    <div class="build-process" id="buildLog">
                        <h4>ğŸ“ æ„å»ºæ—¥å¿—</h4>
                    </div>
                </div>

                <!-- éœå¤«æ›¼æ ‘å¯è§†åŒ– -->
                <div class="section" id="treeSection" style="display: none;">
                    <h2>ğŸŒ³ éœå¤«æ›¼æ ‘</h2>
                    <div class="canvas-container">
                        <svg id="huffmanCanvas" width="800" height="500"></svg>
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color leaf"></div>
                            <span>å¶èŠ‚ç‚¹ï¼ˆå­—ç¬¦ï¼‰</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color internal"></div>
                            <span>å†…éƒ¨èŠ‚ç‚¹</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color root"></div>
                            <span>æ ¹èŠ‚ç‚¹</span>
                        </div>
                        <div class="legend-item">
                            <span style="color: #e91e63; font-weight: bold;">0</span> = å·¦åˆ†æ”¯
                        </div>
                        <div class="legend-item">
                            <span style="color: #2196f3; font-weight: bold;">1</span> = å³åˆ†æ”¯
                        </div>
                    </div>
                </div>

                <!-- ç¼–ç ç»“æœ -->
                <div class="section" id="resultSection" style="display: none;">
                    <h2>ğŸ“‹ éœå¤«æ›¼ç¼–ç è¡¨</h2>
                    <div id="codeTable"></div>

                    <div class="encoded-result">
                        <h4>ğŸ” ç¼–ç ç»“æœ</h4>
                        <div class="stats" id="stats"></div>
                        <div class="encoded-string" id="encodedString"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="#about">å…³äºæˆ‘</a>
                    <a href="https://github.com/FunctionHookTJU" target="_blank">Github</a>
                </div>
                <p class="copyright">Â© 2025 å®‡ä½è§å‡½é’©. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
            </div>
        </div>
    </footer>

    <script>
        // ==================== éœå¤«æ›¼èŠ‚ç‚¹ç±» ====================
        class HuffmanNode {
            constructor(char, freq) {
                this.char = char;       // å­—ç¬¦ï¼ˆå¶èŠ‚ç‚¹ï¼‰
                this.freq = freq;       // é¢‘ç‡
                this.left = null;       // å·¦å­æ ‘
                this.right = null;      // å³å­æ ‘
                this.code = '';         // ç¼–ç 
            }
            
            isLeaf() {
                return this.left === null && this.right === null;
            }
        }

        // ==================== å…¨å±€å˜é‡ ====================
        let inputString = '';
        let freqMap = new Map();
        let nodeQueue = [];
        let buildSteps = [];
        let currentStep = 0;
        let huffmanTree = null;
        let codeMap = new Map();

        // ==================== ä¸»è¦å‡½æ•° ====================
        
        // è®¾ç½®ç¤ºä¾‹
        function setExample(text) {
            document.getElementById('inputString').value = text;
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(msg) {
            const errorEl = document.getElementById('errorMsg');
            errorEl.textContent = msg;
            errorEl.classList.add('show');
        }

        // éšè—é”™è¯¯
        function hideError() {
            document.getElementById('errorMsg').classList.remove('show');
        }

        // éªŒè¯è¾“å…¥
        function validateInput(str) {
            if (!str) {
                showError('è¯·è¾“å…¥å­—ç¬¦ä¸²ï¼');
                return false;
            }
            if (!/^[a-zA-Z]+$/.test(str)) {
                showError('è¯·åªè¾“å…¥å­—æ¯ï¼ˆA-Z, a-zï¼‰ï¼');
                return false;
            }
            if (str.length < 2) {
                showError('è¯·è‡³å°‘è¾“å…¥2ä¸ªå­—ç¬¦ï¼');
                return false;
            }
            hideError();
            return true;
        }

        // ç»Ÿè®¡å­—ç¬¦é¢‘ç‡
        function countFrequency(str) {
            freqMap.clear();
            for (let char of str.toUpperCase()) {
                freqMap.set(char, (freqMap.get(char) || 0) + 1);
            }
            return freqMap;
        }

        // æ˜¾ç¤ºé¢‘ç‡è¡¨æ ¼
        function showFrequencyTable() {
            const section = document.getElementById('freqSection');
            section.style.display = 'block';

            const sorted = [...freqMap.entries()].sort((a, b) => b[1] - a[1]);
            
            let html = '<table class="freq-table">';
            html += '<tr><th>å­—ç¬¦</th><th>å‡ºç°æ¬¡æ•°</th><th>é¢‘ç‡</th></tr>';
            
            const total = inputString.length;
            for (let [char, count] of sorted) {
                const percent = ((count / total) * 100).toFixed(1);
                html += `<tr><td><strong>${char}</strong></td><td>${count}</td><td>${percent}%</td></tr>`;
            }
            html += '</table>';
            
            document.getElementById('freqTable').innerHTML = html;
        }

        // åˆå§‹åŒ–èŠ‚ç‚¹é˜Ÿåˆ—
        function initNodeQueue() {
            nodeQueue = [];
            for (let [char, freq] of freqMap) {
                nodeQueue.push(new HuffmanNode(char, freq));
            }
            // æŒ‰é¢‘ç‡æ’åº
            nodeQueue.sort((a, b) => a.freq - b.freq);
        }

        // å‡†å¤‡æ„å»ºæ­¥éª¤
        function prepareBuildSteps() {
            buildSteps = [];
            let queue = [...nodeQueue];
            let stepNum = 0;

            // åˆå§‹çŠ¶æ€
            buildSteps.push({
                step: stepNum++,
                description: 'åˆå§‹åŒ–ï¼šåˆ›å»ºæ‰€æœ‰å¶èŠ‚ç‚¹',
                queue: queue.map(n => ({char: n.char, freq: n.freq, isLeaf: true})),
                merged: null
            });

            // æ¨¡æ‹Ÿåˆå¹¶è¿‡ç¨‹
            while (queue.length > 1) {
                queue.sort((a, b) => a.freq - b.freq);
                const left = queue.shift();
                const right = queue.shift();
                
                const newNode = new HuffmanNode(null, left.freq + right.freq);
                newNode.left = left;
                newNode.right = right;
                
                queue.push(newNode);
                queue.sort((a, b) => a.freq - b.freq);

                buildSteps.push({
                    step: stepNum++,
                    description: `åˆå¹¶èŠ‚ç‚¹: ${left.char || 'å†…éƒ¨'} (${left.freq}) + ${right.char || 'å†…éƒ¨'} (${right.freq}) = æ–°èŠ‚ç‚¹ (${newNode.freq})`,
                    queue: queue.map(n => ({char: n.char, freq: n.freq, isLeaf: n.isLeaf()})),
                    merged: {left: left.char || `[${left.freq}]`, right: right.char || `[${right.freq}]`, result: newNode.freq}
                });
            }

            document.getElementById('totalSteps').textContent = buildSteps.length - 1;
        }

        // å®é™…æ„å»ºéœå¤«æ›¼æ ‘
        function buildTree() {
            initNodeQueue();
            
            while (nodeQueue.length > 1) {
                nodeQueue.sort((a, b) => a.freq - b.freq);
                const left = nodeQueue.shift();
                const right = nodeQueue.shift();
                
                const newNode = new HuffmanNode(null, left.freq + right.freq);
                newNode.left = left;
                newNode.right = right;
                
                nodeQueue.push(newNode);
            }
            
            huffmanTree = nodeQueue[0];
            return huffmanTree;
        }

        // ç”Ÿæˆç¼–ç 
        function generateCodes(node, code = '') {
            if (!node) return;
            
            if (node.isLeaf()) {
                node.code = code || '0'; // å•ä¸ªå­—ç¬¦æƒ…å†µ
                codeMap.set(node.char, node.code);
            } else {
                generateCodes(node.left, code + '0');
                generateCodes(node.right, code + '1');
            }
        }

        // ä¸€é”®ç”Ÿæˆ
        function buildHuffman() {
            inputString = document.getElementById('inputString').value.trim();
            
            if (!validateInput(inputString)) return;
            
            inputString = inputString.toUpperCase();
            
            // ç»Ÿè®¡é¢‘ç‡
            countFrequency(inputString);
            showFrequencyTable();
            
            // åˆå§‹åŒ–å’Œå‡†å¤‡
            initNodeQueue();
            prepareBuildSteps();
            
            // æ„å»ºæ ‘
            buildTree();
            
            // ç”Ÿæˆç¼–ç 
            codeMap.clear();
            generateCodes(huffmanTree);
            
            // æ˜¾ç¤ºæ‰€æœ‰åŒºåŸŸ
            document.getElementById('processSection').style.display = 'block';
            document.getElementById('treeSection').style.display = 'block';
            document.getElementById('resultSection').style.display = 'block';
            
            // æ˜¾ç¤ºæœ€ç»ˆæ­¥éª¤
            currentStep = buildSteps.length - 1;
            updateStepDisplay();
            showAllBuildLog();
            
            // ç»˜åˆ¶æ ‘
            drawHuffmanTree();
            
            // æ˜¾ç¤ºç¼–ç è¡¨å’Œç»“æœ
            showCodeTable();
            showEncodedResult();
        }

        // å•æ­¥æ„å»º
        function buildStep() {
            inputString = document.getElementById('inputString').value.trim();
            
            if (!validateInput(inputString)) return;
            
            inputString = inputString.toUpperCase();
            
            // é¦–æ¬¡ç‚¹å‡»ï¼Œåˆå§‹åŒ–
            if (currentStep === 0 || !buildSteps.length) {
                countFrequency(inputString);
                showFrequencyTable();
                initNodeQueue();
                prepareBuildSteps();
                
                document.getElementById('processSection').style.display = 'block';
                document.getElementById('treeSection').style.display = 'block';
                
                currentStep = 0;
            }
            
            // æ‰§è¡Œä¸‹ä¸€æ­¥
            if (currentStep < buildSteps.length) {
                updateStepDisplay();
                addBuildLogEntry(buildSteps[currentStep]);
                drawStepTree(currentStep);
                currentStep++;
                
                // å¦‚æœå®Œæˆäº†
                if (currentStep >= buildSteps.length) {
                    // æ„å»ºå®Œæ•´çš„æ ‘å¹¶ç”Ÿæˆç¼–ç 
                    buildTree();
                    codeMap.clear();
                    generateCodes(huffmanTree);
                    
                    document.getElementById('resultSection').style.display = 'block';
                    showCodeTable();
                    showEncodedResult();
                    drawHuffmanTree();
                }
            }
        }

        // æ›´æ–°æ­¥éª¤æ˜¾ç¤º
        function updateStepDisplay() {
            const step = buildSteps[currentStep];
            document.getElementById('stepCounter').textContent = currentStep;
            document.getElementById('stepDescription').textContent = step.description;
        }

        // æ·»åŠ æ„å»ºæ—¥å¿—æ¡ç›®
        function addBuildLogEntry(step) {
            const log = document.getElementById('buildLog');
            const entry = document.createElement('div');
            entry.className = 'build-step active';
            entry.textContent = `æ­¥éª¤ ${step.step}: ${step.description}`;
            log.appendChild(entry);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            log.scrollTop = log.scrollHeight;
            
            // ç§»é™¤ä¹‹å‰çš„active
            setTimeout(() => {
                entry.classList.remove('active');
            }, 500);
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ„å»ºæ—¥å¿—
        function showAllBuildLog() {
            const log = document.getElementById('buildLog');
            log.innerHTML = '<h4>ğŸ“ æ„å»ºæ—¥å¿—</h4>';
            
            for (let step of buildSteps) {
                const entry = document.createElement('div');
                entry.className = 'build-step';
                entry.textContent = `æ­¥éª¤ ${step.step}: ${step.description}`;
                log.appendChild(entry);
            }
        }

        // ==================== ç»˜å›¾å‡½æ•° ====================
        
        function drawHuffmanTree() {
            const svg = document.getElementById('huffmanCanvas');
            svg.innerHTML = '';
            
            if (!huffmanTree) return;
            
            // è®¡ç®—æ ‘çš„å°ºå¯¸
            const treeDepth = getTreeDepth(huffmanTree);
            const treeWidth = Math.pow(2, treeDepth) * 60;
            const treeHeight = treeDepth * 100 + 100;
            
            svg.setAttribute('width', Math.max(treeWidth, 800));
            svg.setAttribute('height', Math.max(treeHeight, 500));
            
            // ç»˜åˆ¶æ ‘
            const startX = svg.getAttribute('width') / 2;
            const startY = 50;
            const levelGap = 80;
            
            drawNode(svg, huffmanTree, startX, startY, treeWidth / 4, levelGap, true);
        }

        function drawNode(svg, node, x, y, hOffset, vOffset, isRoot = false) {
            if (!node) return;
            
            const nodeRadius = 25;
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            
            // ç»˜åˆ¶åˆ°å­èŠ‚ç‚¹çš„è¾¹
            if (node.left) {
                const childX = x - hOffset;
                const childY = y + vOffset;
                drawEdge(svg, x, y + nodeRadius, childX, childY - nodeRadius, '0');
                drawNode(svg, node.left, childX, childY, hOffset / 2, vOffset, false);
            }
            
            if (node.right) {
                const childX = x + hOffset;
                const childY = y + vOffset;
                drawEdge(svg, x, y + nodeRadius, childX, childY - nodeRadius, '1');
                drawNode(svg, node.right, childX, childY, hOffset / 2, vOffset, false);
            }
            
            // ç¡®å®šèŠ‚ç‚¹é¢œè‰²
            let fillColor;
            if (isRoot) {
                fillColor = '#E91E63';
            } else if (node.isLeaf()) {
                fillColor = '#4CAF50';
            } else {
                fillColor = '#FF9800';
            }
            
            // ç»˜åˆ¶èŠ‚ç‚¹åœ†
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', nodeRadius);
            circle.setAttribute('fill', fillColor);
            circle.setAttribute('stroke', '#333');
            circle.setAttribute('stroke-width', '2');
            g.appendChild(circle);
            
            // èŠ‚ç‚¹æ–‡æœ¬
            if (node.isLeaf()) {
                // å¶èŠ‚ç‚¹æ˜¾ç¤ºå­—ç¬¦
                const charText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                charText.setAttribute('x', x);
                charText.setAttribute('y', y - 3);
                charText.setAttribute('text-anchor', 'middle');
                charText.setAttribute('font-size', '16');
                charText.setAttribute('font-weight', 'bold');
                charText.setAttribute('fill', 'white');
                charText.textContent = node.char;
                g.appendChild(charText);
                
                // é¢‘ç‡
                const freqText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                freqText.setAttribute('x', x);
                freqText.setAttribute('y', y + 12);
                freqText.setAttribute('text-anchor', 'middle');
                freqText.setAttribute('font-size', '11');
                freqText.setAttribute('fill', 'white');
                freqText.textContent = `(${node.freq})`;
                g.appendChild(freqText);
            } else {
                // å†…éƒ¨èŠ‚ç‚¹æ˜¾ç¤ºé¢‘ç‡
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', y + 5);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '14');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('fill', 'white');
                text.textContent = node.freq;
                g.appendChild(text);
            }
            
            svg.appendChild(g);
        }

        function drawEdge(svg, x1, y1, x2, y2, label) {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            
            // è¾¹
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.setAttribute('stroke', '#666');
            line.setAttribute('stroke-width', '2');
            g.appendChild(line);
            
            // è¾¹ä¸Šçš„æ ‡ç­¾ (0 æˆ– 1)
            const midX = (x1 + x2) / 2;
            const midY = (y1 + y2) / 2;
            
            const labelBg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            labelBg.setAttribute('cx', midX);
            labelBg.setAttribute('cy', midY);
            labelBg.setAttribute('r', 12);
            labelBg.setAttribute('fill', 'white');
            labelBg.setAttribute('stroke', label === '0' ? '#E91E63' : '#2196F3');
            labelBg.setAttribute('stroke-width', '2');
            g.appendChild(labelBg);
            
            const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            labelText.setAttribute('x', midX);
            labelText.setAttribute('y', midY + 5);
            labelText.setAttribute('text-anchor', 'middle');
            labelText.setAttribute('font-size', '14');
            labelText.setAttribute('font-weight', 'bold');
            labelText.setAttribute('fill', label === '0' ? '#E91E63' : '#2196F3');
            labelText.textContent = label;
            g.appendChild(labelText);
            
            svg.appendChild(g);
        }

        function getTreeDepth(node) {
            if (!node) return 0;
            return 1 + Math.max(getTreeDepth(node.left), getTreeDepth(node.right));
        }

        // ç»˜åˆ¶æ„å»ºæ­¥éª¤çš„æ ‘
        function drawStepTree(stepIndex) {
            const svg = document.getElementById('huffmanCanvas');
            svg.innerHTML = '';
            
            const step = buildSteps[stepIndex];
            if (!step) return;
            
            // ç»˜åˆ¶å½“å‰é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹
            const nodes = step.queue;
            const startX = 50;
            const y = 200;
            const gap = 100;
            
            nodes.forEach((node, index) => {
                const x = startX + index * gap;
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                
                // èŠ‚ç‚¹
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', 25);
                circle.setAttribute('fill', node.isLeaf ? '#4CAF50' : '#FF9800');
                circle.setAttribute('stroke', '#333');
                circle.setAttribute('stroke-width', '2');
                g.appendChild(circle);
                
                // æ–‡æœ¬
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', y - 3);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', node.char ? '16' : '14');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('fill', 'white');
                text.textContent = node.char || node.freq;
                g.appendChild(text);
                
                if (node.char) {
                    const freqText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    freqText.setAttribute('x', x);
                    freqText.setAttribute('y', y + 12);
                    freqText.setAttribute('text-anchor', 'middle');
                    freqText.setAttribute('font-size', '11');
                    freqText.setAttribute('fill', 'white');
                    freqText.textContent = `(${node.freq})`;
                    g.appendChild(freqText);
                }
                
                svg.appendChild(g);
            });
            
            // æ ‡é¢˜
            const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            title.setAttribute('x', 400);
            title.setAttribute('y', 50);
            title.setAttribute('text-anchor', 'middle');
            title.setAttribute('font-size', '18');
            title.setAttribute('font-weight', 'bold');
            title.setAttribute('fill', '#667eea');
            title.textContent = `æ­¥éª¤ ${stepIndex}: å½“å‰é˜Ÿåˆ— (${nodes.length} ä¸ªèŠ‚ç‚¹)`;
            svg.appendChild(title);
        }

        // æ˜¾ç¤ºç¼–ç è¡¨
        function showCodeTable() {
            const sorted = [...codeMap.entries()].sort((a, b) => a[1].length - b[1].length);
            
            let html = '<table class="code-table">';
            html += '<tr><th>å­—ç¬¦</th><th>é¢‘ç‡</th><th>éœå¤«æ›¼ç¼–ç </th><th>ç¼–ç é•¿åº¦</th></tr>';
            
            for (let [char, code] of sorted) {
                const freq = freqMap.get(char);
                html += `<tr>
                    <td><strong>${char}</strong></td>
                    <td>${freq}</td>
                    <td class="code">${code}</td>
                    <td>${code.length} bit</td>
                </tr>`;
            }
            html += '</table>';
            
            document.getElementById('codeTable').innerHTML = html;
        }

        // æ˜¾ç¤ºç¼–ç ç»“æœ
        function showEncodedResult() {
            // ç¼–ç æ•´ä¸ªå­—ç¬¦ä¸²
            let encoded = '';
            for (let char of inputString) {
                encoded += codeMap.get(char);
            }
            
            // ç»Ÿè®¡
            const originalBits = inputString.length * 8; // ASCII 8ä½
            const encodedBits = encoded.length;
            const ratio = ((1 - encodedBits / originalBits) * 100).toFixed(1);
            
            // å¹³å‡ç¼–ç é•¿åº¦
            let avgLength = 0;
            const total = inputString.length;
            for (let [char, code] of codeMap) {
                avgLength += (freqMap.get(char) / total) * code.length;
            }
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-item">åŸæ–‡: <strong>${inputString.length}</strong> å­—ç¬¦</div>
                <div class="stat-item">åŸå§‹: <strong>${originalBits}</strong> bits (ASCII)</div>
                <div class="stat-item">å‹ç¼©å: <strong>${encodedBits}</strong> bits</div>
                <div class="stat-item">å‹ç¼©ç‡: <strong>${ratio}%</strong></div>
                <div class="stat-item">å¹³å‡ç é•¿: <strong>${avgLength.toFixed(2)}</strong> bit/å­—ç¬¦</div>
            `;
            
            // ç¼–ç å­—ç¬¦ä¸²ï¼ˆåˆ†ç»„æ˜¾ç¤ºï¼‰
            let formattedCode = '';
            for (let i = 0; i < inputString.length; i++) {
                const char = inputString[i];
                const code = codeMap.get(char);
                formattedCode += `<span title="${char}" style="color: ${getCharColor(i)};">${code}</span> `;
            }
            
            document.getElementById('encodedString').innerHTML = `
                <strong>åŸæ–‡:</strong> ${inputString}<br><br>
                <strong>ç¼–ç :</strong> ${formattedCode}<br><br>
                <strong>è¿ç»­ç¼–ç :</strong> ${encoded}
            `;
        }

        function getCharColor(index) {
            const colors = ['#E91E63', '#9C27B0', '#3F51B5', '#2196F3', '#009688', '#4CAF50', '#FF9800', '#795548'];
            return colors[index % colors.length];
        }

        // é‡ç½®
        function resetAll() {
            document.getElementById('inputString').value = '';
            document.getElementById('freqSection').style.display = 'none';
            document.getElementById('processSection').style.display = 'none';
            document.getElementById('treeSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('buildLog').innerHTML = '<h4>ğŸ“ æ„å»ºæ—¥å¿—</h4>';
            document.getElementById('huffmanCanvas').innerHTML = '';
            
            hideError();
            
            inputString = '';
            freqMap.clear();
            nodeQueue = [];
            buildSteps = [];
            currentStep = 0;
            huffmanTree = null;
            codeMap.clear();
        }

        // å›è½¦é”®è§¦å‘
        document.getElementById('inputString').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buildHuffman();
            }
        });
    </script>
</body>
</html>
