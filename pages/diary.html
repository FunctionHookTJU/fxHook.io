<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è®° - å®‡ä½è§å‡½é’©</title>
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/icons/favicon-16x16.png">
    <link rel="manifest" href="../site.webmanifest">
    <script src="../scripts/header.js" defer></script>
    <script src="../scripts/backgroundLoader.js"></script>
    <script src="../scripts/diaryAPI.js"></script>
</head>
<body>
    <script>
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–èƒŒæ™¯åŠ è½½å™¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('åˆå§‹åŒ–èƒŒæ™¯åŠ è½½å™¨...');
            window.initBackgroundLoader({
                path: 'https://cdn.jsdelivr.net/gh/FunctionHookTJU/fxHook.io@master/assets/images/bg/',
                blurAmount: 0,
                transitionDuration: 400
            });
        });
    </script>
    <!-- å¯†ç ä¿æŠ¤é®ç½©å±‚ -->
    <!-- <div id="password-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(245, 245, 245, 0.29); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        æ¬¢è¿æ–‡å­—
        <div id="welcome-message" style="display: none; color: white; font-size: 32px; font-weight: bold; text-align: center; opacity: 0; transition: opacity 1s ease-in-out;">
            ä¸»äººï¼Œæ¬¢è¿å›å®¶ï¼
        </div>
        å¯†ç è¾“å…¥æ¡†
        <div id="password-box" style="background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); text-align: center; max-width: 400px; display: none;">
            <h2 style="margin-bottom: 20px; color: #333;">ğŸ”’ æ­¤é¡µé¢éœ€è¦å¯†ç è®¿é—®</h2>
            <input type="password" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç " style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; margin-bottom: 15px; box-sizing: border-box;">
            <button onclick="checkPassword()" style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background 0.3s;">ç¡®è®¤</button>
            <p id="error-message" style="color: red; margin-top: 15px; display: none;">âŒ å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</p>
        </div>
    </div> -->
    
    <div class="container diary-container" id="diary-content">
        <main class="diary-main">
            <section class="content-section">
                <h2>æˆ‘çš„æ—¥è®°</h2>
                <div id="diary-entries">
                    <!-- æ—¥è®°å†…å®¹å°†é€šè¿‡APIåŠ¨æ€åŠ è½½ -->
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #666;">æ­£åœ¨åŠ è½½æ—¥è®°...</p>
                    </div>
                </div>
                
                <!-- åˆ†é¡µæ§ä»¶ -->
                <div class="pagination">
                    <button class="pagination-btn" id="prev-page" disabled>ä¸Šä¸€é¡µ</button>
                    <span class="page-info" id="page-info">ç¬¬ 1 é¡µ</span>
                    <button class="pagination-btn" id="next-page">ä¸‹ä¸€é¡µ</button>
                </div>
            </section>
        </main>

        <aside>
            <section class="calendar-section">
                <h2>ä¸‡å¹´å†</h2>
                <div class="calendar">
                    <div class="calendar-header">
                        <button class="calendar-nav" id="prev-month">&lt;</button>
                        <div class="calendar-title" id="calendar-title">2025å¹´7æœˆ</div>
                        <button class="calendar-nav" id="next-month">&gt;</button>
                    </div>
                    <table class="calendar-table">
                        <thead>
                            <tr>
                                <th>æ—¥</th>
                                <th>ä¸€</th>
                                <th>äºŒ</th>
                                <th>ä¸‰</th>
                                <th>å››</th>
                                <th>äº”</th>
                                <th>å…­</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-body">
                            <!-- æ—¥å†å†…å®¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </section>
        </aside>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="../index.html#about">å…³äºæˆ‘</a>
                    <a href="https://github.com/FunctionHookTJU" target="_blank">Github</a>
                </div>
                <p class="copyright">Â© 2025 å®‡ä½è§å‡½é’©. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
            </div>
        </div>
    </footer>

    <script>
        /* æ—¥è®°é”åŠŸèƒ½å·²æ³¨é‡Š
        // å¯†ç éªŒè¯åŠŸèƒ½ï¼ˆä½¿ç”¨SHA-256å“ˆå¸Œï¼‰
        async function checkPassword() {
            const passwordInput = document.getElementById('password-input');
            const errorMessage = document.getElementById('error-message');
            const password = passwordInput.value.trim();
            
            // éšè—ä¹‹å‰çš„é”™è¯¯æ¶ˆæ¯
            errorMessage.style.display = 'none';
            
            // æ£€æŸ¥å¯†ç æ˜¯å¦ä¸ºç©º
            if (!password) {
                errorMessage.textContent = 'è¯·è¾“å…¥å¯†ç ';
                errorMessage.style.display = 'block';
                passwordInput.focus();
                return;
            }
            
            try {
                // å­˜å‚¨å¯†ç çš„SHA-256å“ˆå¸Œå€¼
                 const correctPasswordHash = '087b363af09a6799d197d3c7d54439217d95a87490b9977ee0f141997a6b7a6f';
                
                // è®¡ç®—ç”¨æˆ·è¾“å…¥å¯†ç çš„å“ˆå¸Œå€¼
                const inputHash = await hashPassword(password);
                
                console.log('è¾“å…¥å¯†ç å“ˆå¸Œ:', inputHash);
                console.log('æ­£ç¡®å¯†ç å“ˆå¸Œ:', correctPasswordHash);
                
                if (inputHash === correctPasswordHash) {
                    // å¯†ç æ­£ç¡®ï¼Œéšè—é®ç½©å¹¶æ˜¾ç¤ºæ—¥è®°å†…å®¹
                    document.getElementById('password-overlay').style.display = 'none';
                    document.getElementById('diary-content').style.display = 'flex';
                    // ä¿å­˜å¯†ç éªŒè¯çŠ¶æ€åˆ°sessionStorage
                    sessionStorage.setItem('diaryAccess', 'granted');
                    console.log('å¯†ç éªŒè¯æˆåŠŸ');
                } else {
                    // å¯†ç é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    errorMessage.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
                    errorMessage.style.display = 'block';
                    passwordInput.value = '';
                    passwordInput.focus();
                    console.log('å¯†ç éªŒè¯å¤±è´¥');
                }
            } catch (error) {
                console.error('å¯†ç éªŒè¯è¿‡ç¨‹å‡ºé”™:', error);
                errorMessage.textContent = 'éªŒè¯è¿‡ç¨‹å‡ºé”™ï¼Œè¯·é‡è¯•';
                errorMessage.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        
        // ä½¿ç”¨SHA-256è®¡ç®—å¯†ç å“ˆå¸Œ
        async function hashPassword(password) {
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
        
        // IPç™½åå•æ£€æŸ¥å’Œå¯†ç éªŒè¯
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»éªŒè¯è¿‡å¯†ç 
            if (sessionStorage.getItem('diaryAccess') === 'granted') {
                document.getElementById('password-overlay').style.display = 'none';
                document.getElementById('diary-content').style.display = 'flex';
                return;
            }
            
            // ç™½åå•IPçš„SHA-256å“ˆå¸Œå€¼
            const whitelistIPHashes = [
                '06c48391e984f87b7fa2782fd5a93dcce288d50ba9506c42c21fd9ecb1a61a65',
                '15340fa47c4c40a7961f17a5199413747226213d4f27e23414c395ef802b2a7f', 
                'b51477e592b153f9019de9eabc1d203c51ffcf39585a3bb164e32552f2de9521',
                '71e12b3ca40b19dcb29fd67c74c0a814c421c90fb170924a01b8c9284f49bdcf' 
            ];
            
            // è·å–è®¿é—®è€…IPåœ°å€
            fetch('https://api.ip.sb/ip')
                .then(response => response.text())
                .then(async ip => {
                    const visitorIP = ip.trim();
                    console.log('æ­£åœ¨éªŒè¯è®¿é—®æƒé™...');
                    console.log('æ£€æµ‹åˆ°IPåœ°å€:', visitorIP);
                    
                    // è®¡ç®—è®¿é—®è€…IPçš„å“ˆå¸Œå€¼
                    const visitorIPHash = await hashPassword(visitorIP);
                    console.log('IPå“ˆå¸Œå€¼:', visitorIPHash);
                    console.log('ç™½åå•å“ˆå¸Œå€¼:', whitelistIPHashes);
                    
                    if (whitelistIPHashes.includes(visitorIPHash)) {
                        console.log('IPåœ¨ç™½åå•ä¸­ï¼Œå…è®¸ç›´æ¥è®¿é—®');
                        // IPåœ¨ç™½åå•ä¸­ï¼Œæ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
                        showWelcomeMessage();
                    } else {
                        console.log('IPä¸åœ¨ç™½åå•ä¸­ï¼Œéœ€è¦å¯†ç éªŒè¯');
                        // IPä¸åœ¨ç™½åå•ä¸­ï¼Œæ˜¾ç¤ºå¯†ç è¾“å…¥æ¡†
                        showPasswordBox();
                    }
                })
                .catch(error => {
                    console.error('IPæŸ¥è¯¢å¤±è´¥:', error);
                    // å¦‚æœIPæŸ¥è¯¢å¤±è´¥ï¼Œæ˜¾ç¤ºå¯†ç è¾“å…¥æ¡†
                    showPasswordBox();
                });
            
            // æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯å¹¶æ·¡å…¥æ·¡å‡º
            function showWelcomeMessage() {
                const welcomeMsg = document.getElementById('welcome-message');
                welcomeMsg.style.display = 'block';
                
                // æ·¡å…¥
                setTimeout(() => {
                    welcomeMsg.style.opacity = '1';
                }, 100);
                
                // 2ç§’åæ·¡å‡º
                setTimeout(() => {
                    welcomeMsg.style.opacity = '0';
                }, 2000);
                
                // æ·¡å‡ºå®Œæˆåæ˜¾ç¤ºæ—¥è®°å†…å®¹
                setTimeout(() => {
                    document.getElementById('password-overlay').style.display = 'none';
                    document.getElementById('diary-content').style.display = 'flex';
                    sessionStorage.setItem('diaryAccess', 'granted');
                }, 3000);
            }
            
            // æ˜¾ç¤ºå¯†ç è¾“å…¥æ¡†
            function showPasswordBox() {
                document.getElementById('password-box').style.display = 'block';
                const passwordInput = document.getElementById('password-input');
                if (passwordInput) {
                    passwordInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            checkPassword();
                        }
                    });
                    passwordInput.focus();
                }
            }
        });
        */
        
        // æ—¥è®°åˆ†é¡µåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–å½“å‰é¡µç 
            window.currentDiaryPage = 1;

            // åŠ è½½ç¬¬ä¸€é¡µæ—¥è®°
            loadDiaries(1);
            
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            
            // ä¸Šä¸€é¡µ
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', function() {
                    if (window.currentDiaryPage > 1) {
                        loadDiaries(window.currentDiaryPage - 1);
                        document.querySelector('.content-section').scrollIntoView({ behavior: 'smooth' });
                    }
                });
            }
            
            // ä¸‹ä¸€é¡µ
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', function() {
                    loadDiaries(window.currentDiaryPage + 1);
                    document.querySelector('.content-section').scrollIntoView({ behavior: 'smooth' });
                });
            }

            // æ—¥å†åŠŸèƒ½å®ç°
            const calendarBody = document.getElementById('calendar-body');
            const calendarTitle = document.getElementById('calendar-title');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            
            let currentDate = new Date();
            let currentYear = currentDate.getFullYear();
            let currentMonth = currentDate.getMonth();
            
            // æ¸²æŸ“æ—¥å†
            function renderCalendar(year, month) {
                // æ›´æ–°æ ‡é¢˜
                const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ',
                                   '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                calendarTitle.textContent = `${year}å¹´${monthNames[month]}`;
                
                // æ¸…ç©ºæ—¥å†
                calendarBody.innerHTML = '';
                
                // è·å–æœˆä»½çš„ç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                // è·å–ä¸Šä¸ªæœˆçš„æœ€åä¸€å¤©
                const prevLastDay = new Date(year, month, 0).getDate();
                
                // è·å–ç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡  (0=æ˜ŸæœŸæ—¥, 6=æ˜ŸæœŸå…­)
                const firstDayOfWeek = firstDay.getDay();
                
                // è·å–æœ€åä¸€å¤©æ˜¯æ˜ŸæœŸå‡ 
                const lastDayOfWeek = lastDay.getDay();
                
                // è®¡ç®—éœ€è¦æ˜¾ç¤ºçš„å‘¨æ•°
                const daysInMonth = lastDay.getDate();
                const weeksNeeded = Math.ceil((firstDayOfWeek + daysInMonth) / 7);
                
                // åˆ›å»ºæ—¥å†è¡¨æ ¼
                let date = 1;
                let nextMonthDate = 1;
                
                for (let week = 0; week < weeksNeeded; week++) {
                    const row = document.createElement('tr');
                    
                    for (let day = 0; day < 7; day++) {
                        const cell = document.createElement('td');
                        
                        if (week === 0 && day < firstDayOfWeek) {
                            // ä¸Šä¸ªæœˆçš„æ—¥æœŸ
                            const prevDate = prevLastDay - firstDayOfWeek + day + 1;
                            cell.textContent = prevDate;
                            cell.classList.add('other-month');
                        } else if (date > daysInMonth) {
                            // ä¸‹ä¸ªæœˆçš„æ—¥æœŸ
                            cell.textContent = nextMonthDate;
                            cell.classList.add('other-month');
                            nextMonthDate++;
                        } else {
                            // å½“å‰æœˆçš„æ—¥æœŸ
                            cell.textContent = date;
                            
                            // æ ‡è®°ä»Šå¤©
                            if (date === currentDate.getDate() && 
                                month === currentDate.getMonth() && 
                                year === currentDate.getFullYear()) {
                                cell.classList.add('today');
                            }
                            
                            date++;
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    calendarBody.appendChild(row);
                }
            }
            
            // åˆå§‹åŒ–æ—¥å†
            renderCalendar(currentYear, currentMonth);
            
            // ä¸Šä¸€ä¸ªæœˆ
            prevMonthBtn.addEventListener('click', function() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar(currentYear, currentMonth);
            });
            
            // ä¸‹ä¸€ä¸ªæœˆ
            nextMonthBtn.addEventListener('click', function() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar(currentYear, currentMonth);
            });
        });
    </script>
</body>
</html>
